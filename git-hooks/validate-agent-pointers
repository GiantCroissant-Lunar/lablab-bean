#!/bin/bash
# Validate agent pointer files are in sync
# Checks if CLAUDE.md, AGENTS.md, .github/copilot-instructions.md, .windsurf/rules.md need updating

set -e

echo "Validating agent pointer files..."

# Get staged files that affect pointer generation
STAGED_FILES=$(git diff --cached --name-only || true)

# Check if any .agent/ files or pointer files are modified
if echo "$STAGED_FILES" | grep -qE '^\.agent/|^CLAUDE\.md|^AGENTS\.md|^\.github/copilot-instructions\.md|^\.windsurf/rules\.md'; then
    echo "Detected changes to agent files or pointer files"

    # Check if Python is available
    if ! command -v python &> /dev/null && ! command -v python3 &> /dev/null; then
        echo "Error: Python not found. Cannot validate pointer files."
        exit 1
    fi

    # Use python3 if available, otherwise python
    PYTHON_CMD="python3"
    if ! command -v python3 &> /dev/null; then
        PYTHON_CMD="python"
    fi

    # Run the validation
    if $PYTHON_CMD .agent/scripts/generate_pointers.py --check; then
        echo "✓ Agent pointer files are up to date"
    else
        echo ""
        echo "❌ Agent pointer files are out of sync!"
        echo ""
        echo "To fix, run:"
        echo "  python .agent/scripts/generate_pointers.py"
        echo "  git add CLAUDE.md AGENTS.md .github/copilot-instructions.md .windsurf/rules.md"
        echo ""
        exit 1
    fi
else
    echo "No agent files modified, skipping validation"
fi

echo "✓ Agent pointer validation passed"
