<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report_title }} - Plugin Health Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .content {
            padding: 30px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #4facfe;
        }

        .metric-card.healthy {
            border-left-color: #10b981;
        }

        .metric-card.warning {
            border-left-color: #f59e0b;
        }

        .metric-card.critical {
            border-left-color: #ef4444;
        }

        .metric-label {
            font-size: 0.85em;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: 600;
            color: #1f2937;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .plugin-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #10b981;
        }

        .plugin-card.warning {
            border-left-color: #f59e0b;
        }

        .plugin-card.critical {
            border-left-color: #ef4444;
        }

        .plugin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .plugin-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
        }

        .plugin-version {
            font-size: 0.9em;
            color: #6b7280;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.healthy {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.degraded {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.disabled {
            background: #e5e7eb;
            color: #374151;
        }

        .badge {
            display: inline-block;
            font-size: 0.75em;
            padding: 3px 6px;
            border-radius: 999px;
            margin-right: 6px;
        }

        .badge-ok {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .badge-fail {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fca5a5;
        }

        .plugin-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }

        .detail-label {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 600;
            color: #1f2937;
        }

        .error-list {
            margin-top: 15px;
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 6px;
        }

        .error-list h4 {
            color: #991b1b;
            margin-bottom: 10px;
        }

        .error-item {
            padding: 8px 0;
            border-bottom: 1px solid #fca5a5;
            color: #7f1d1d;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-size: 0.9em;
        }

        .health-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .health-indicator.healthy {
            background: #10b981;
        }

        .health-indicator.warning {
            background: #f59e0b;
        }

        .health-indicator.critical {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ report_title }}</h1>
            <div class="subtitle">Plugin Health Report • Generated {{ generated_at | date.to_string '%Y-%m-%d %H:%M:%S UTC' }}</div>
            {{ if version }}
            <div class="subtitle">Version: {{ version }}</div>
            {{ end }}
            {{ if filters }}
            <div class="subtitle">
                {{ if filters.include }}Include: {{ for it in filters.include }}{{ it }}{{ if for.last }}{{ else }}, {{ end }}{{ end }}{{ end }}
                {{ if filters.exclude }} {{ if filters.include }}• {{ end }}Exclude: {{ for it in filters.exclude }}{{ it }}{{ if for.last }}{{ else }}, {{ end }}{{ end }}{{ end }}
            </div>
            {{ end }}
        </div>

        <div class="content">
            <!-- Overall Summary -->
            <div class="section">
                <h2>System Overview</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Plugins</div>
                        <div class="metric-value">{{ total_plugins }}</div>
                    </div>
                    <div class="metric-card healthy">
                        <div class="metric-label">Running</div>
                        <div class="metric-value">{{ running_plugins }}</div>
                    </div>
                    <div class="metric-card warning">
                        <div class="metric-label">Degraded</div>
                        <div class="metric-value">{{ degraded_plugins }}</div>
                    </div>
                    <div class="metric-card critical">
                        <div class="metric-label">Failed</div>
                        <div class="metric-value">{{ failed_plugins }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Success Rate</div>
                        <div class="metric-value" style="font-size: 1.5em;">
                            {{ if success_rate >= 90 }}
                            <span style="color: #10b981;">{{ success_rate | math.round 1 }}%</span>
                            {{ else if success_rate >= 70 }}
                            <span style="color: #f59e0b;">{{ success_rate | math.round 1 }}%</span>
                            {{ else }}
                            <span style="color: #ef4444;">{{ success_rate | math.round 1 }}%</span>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plugin Details -->
            <div class="section">
                <h2>Plugin Status</h2>

                {{ for plugin in plugins }}
                <div class="plugin-card {{ if plugin.state == 'Running' }}{{ else if plugin.state == 'Degraded' }}warning{{ else }}critical{{ end }}">
                    <div class="plugin-header">
                        <div>
                            <div class="plugin-name">
                                <span class="health-indicator {{ if plugin.state == 'Running' }}healthy{{ else if plugin.state == 'Degraded' }}warning{{ else }}critical{{ end }}"></span>
                                {{ plugin.name }}
                            </div>
                            <div class="plugin-version">Version {{ plugin.version }}</div>
                            {{ if plugin.contract_probes }}
                            <div style="margin-top:6px;">
                                {{ for kv in plugin.contract_probes }}
                                <span class="badge {{ if kv.value.ok }}badge-ok{{ else }}badge-fail{{ end }}" title="{{ if kv.value.message }}{{ kv.value.message }}{{ end }}">
                                    {{ kv.key }}: {{ if kv.value.ok }}PASS{{ else }}FAIL{{ end }}
                                </span>
                                {{ end }}
                            </div>
                            {{ end }}
                        </div>
                        <span class="status-badge {{ if plugin.state == 'Running' }}healthy{{ else if plugin.state == 'Degraded' }}degraded{{ else if plugin.state == 'Failed' }}error{{ else }}disabled{{ end }}">
                            {{ plugin.state }}
                        </span>
                    </div>

                    <div class="plugin-details">
                        <div class="detail-item">
                            <div class="detail-label">Load Time</div>
                            <div class="detail-value">{{ plugin.load_duration | format_time_span }}</div>
                        </div>
                        {{ if plugin.memory_usage_mb > 0 }}
                        <div class="detail-item">
                            <div class="detail-label">Memory Usage</div>
                            <div class="detail-value">{{ plugin.memory_usage_mb }} MB</div>
                        </div>
                        {{ end }}
                        {{ if plugin.health_status_reason }}
                        <div class="detail-item">
                            <div class="detail-label">Status Reason</div>
                            <div class="detail-value" style="color: #f59e0b;">{{ plugin.health_status_reason }}</div>
                        </div>
                        {{ end }}
                    </div>

                    {{ if plugin.error_message }}
                    <div class="error-list">
                        <h4>Error</h4>
                        <div class="error-item">{{ plugin.error_message }}</div>
                    </div>
                    {{ end }}
                </div>
                {{ end }}
            </div>

            <!-- Recommendations -->
            {{ if failed_plugins > 0 || degraded_plugins > 0 }}
            <div class="section">
                <h2>Recommendations</h2>
                <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #92400e; margin-bottom: 10px;">Action Items:</h4>
                    <ul style="margin-left: 20px; color: #78350f;">
                        {{ if failed_plugins > 0 }}
                        <li>Investigate and resolve {{ failed_plugins }} failed plugin(s) immediately</li>
                        {{ end }}
                        {{ if degraded_plugins > 0 }}
                        <li>Review {{ degraded_plugins }} degraded plugin(s) for performance issues</li>
                        {{ end }}
                        <li>Monitor system health and check logs for error patterns</li>
                        <li>Consider updating plugins with errors</li>
                    </ul>
                </div>
            </div>
            {{ end }}
        </div>

        <div class="footer">
            Generated by LablabBean Reporting System • Success Rate: {{ success_rate | math.round 1 }}%
        </div>
    </div>
</body>
</html>
