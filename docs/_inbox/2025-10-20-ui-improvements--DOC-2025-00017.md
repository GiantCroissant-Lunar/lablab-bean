---
doc_id: DOC-2025-00017
title: UI Improvements Specification
doc_type: spec
status: draft
canonical: false
created: 2025-10-20
tags: [ui, terminal-gui, activity-log, monster-ai, rendering]
summary: >
  Specification for UI improvements including duplicate message removal,
  rendering artifact fixes, monster AI aggro range, and activity log system.
source:
  author: agent
  agent: claude
  model: sonnet-4.5
---

# UI Improvements Specification

**Version**: 0.0.3
**Status**: In Progress
**Author**: Development Team
**Date**: 2025-10-20

## Overview

Address UI issues and improve the dungeon crawler user interface by removing duplicate message displays, fixing rendering artifacts, improving monster AI, and adding an activity log system.

## Requirements

### Functional Requirements

- **REQ-001**: Remove duplicate "Messages" panel (already shown in Debug Log)
- **REQ-002**: Fix weird characters rendering near HUD panel on right side
- **REQ-003**: Improve monster AI to only activate near player (aggro range)
- **REQ-004**: Add Activity Log tab for game events (damage, pickups, deaths)
- **REQ-005**: Integrate activity log with Microsoft.Extensions.Logging
- **REQ-006**: Activity log should show color-coded messages (damage=red, info=white, success=green)

### Non-Functional Requirements

- **NFREQ-001**: Activity log must not impact game performance
- **NFREQ-002**: UI changes must not break existing rendering
- **NFREQ-003**: Logging system must be extensible for future event types

## Issues Analysis

### Issue 1: Duplicate Messages Panel

**Current State**: Messages shown in both dedicated panel and Debug Log
**Problem**: Visual clutter, redundant information
**Solution**: Remove Messages panel, keep only Debug Log for technical info and new Activity Log for gameplay

### Issue 2: Weird Characters Near HUD

**Current State**: Strange characters appear on right side near HUD panel
**Likely Causes**:

- Buffer overflow in rendering
- Incorrect bounds calculation
- String trimming issues
- Character encoding problems
**Solution**: Review WorldViewService rendering bounds and MapView layout

### Issue 3: Monster Swarm Behavior

**Current State**: All monsters move simultaneously, player gets surrounded
**Expected Behavior**: Only monsters within aggro range should activate
**Root Cause**: AI updates all monsters regardless of distance
**Solution**: Implement aggro range check before monster AI update

### Issue 4: Activity Log Missing

**Current State**: No in-game feedback for combat/events
**Need**: Roguelike-style message log for game events
**Solution**: Add tabbed interface with Activity Log tab

## Architecture

### Components

1. **ActivityLogService** (`LablabBean.Game.TerminalUI/Services/ActivityLogService.cs`)
   - Manages activity log messages
   - Integrates with ILogger
   - Provides color-coded message formatting
   - Thread-safe message queue

2. **ActivityLogView** (`LablabBean.Game.TerminalUI/Views/ActivityLogView.cs`)
   - Displays activity log messages
   - Auto-scrolls to latest
   - Color-coded text rendering

3. **HudService** (Modified - `LablabBean.Game.TerminalUI/Services/HudService.cs`)
   - Remove Messages ListView
   - Add TabView with Debug Log and Activity Log tabs
   - Fix bounds calculation

4. **MonsterAI** (Modified - `LablabBean.Game.Core/AI/MonsterAI.cs`)
   - Add aggro range check
   - Only activate monsters within range
   - Optimize update loop

5. **WorldViewService** (Modified - `LablabBean.Game.TerminalUI/Services/WorldViewService.cs`)
   - Fix rendering bounds
   - Prevent buffer overflow
   - Correct character encoding

6. **CustomLogger** (`LablabBean.Game.Core/Logging/ActivityLogger.cs`)
   - Custom ILogger implementation
   - Routes game events to ActivityLogService
   - Filters by log category

### Data Flow

```
Game Event (e.g., Combat)
    ↓
ILogger.LogInformation("Monster takes damage")
    ↓
ActivityLogger (custom logger provider)
    ↓
ActivityLogService (message queue)
    ↓
ActivityLogView (display with colors)
```

## Implementation Plan

### Phase 1: Fix Immediate UI Issues (30 min)

1. **Remove Messages Panel**
   - Edit `HudService.cs`
   - Remove `_messagesListView`
   - Adjust layout

2. **Fix Rendering Artifacts**
   - Review `WorldViewService.cs` bounds calculation
   - Check `MapView.cs` rendering logic
   - Fix string trimming

### Phase 2: Improve Monster AI (20 min)

1. **Add Aggro Range Check**
   - Edit `GameStateManager.cs` or `MonsterAI.cs`
   - Calculate distance to player
   - Only update if distance <= aggro range
   - Add logging for debugging

### Phase 3: Activity Log System (45 min)

1. **Create ActivityLogService**
   - Message queue (thread-safe)
   - Add message with color
   - Get recent messages
   - Clear old messages

2. **Create ActivityLogView**
   - ListView for messages
   - Color attribute support
   - Auto-scroll to bottom

3. **Add TabView to HUD**
   - Tab 1: Debug Log
   - Tab 2: Activity Log
   - Switch between tabs

4. **Custom Logger Implementation**
   - ActivityLoggerProvider
   - ActivityLogger
   - Register in DI container

## Configuration

```csharp
// In GameStateManager.cs or appsettings.json
public class MonsterAISettings
{
    public int AggroRange { get; set; } = 15;  // Tiles
    public bool UpdateOnlyInRange { get; set; } = true;
}

public class ActivityLogSettings
{
    public int MaxMessages { get; set; } = 100;
    public bool ShowTimestamp { get; set; } = false;
    public bool ColorCodeMessages { get; set; } = true;
}
```

## Files to Modify

### Remove Messages Panel

- `dotnet/framework/LablabBean.Game.TerminalUI/Services/HudService.cs`

### Fix Rendering Artifacts

- `dotnet/framework/LablabBean.Game.TerminalUI/Services/WorldViewService.cs`
- `dotnet/framework/LablabBean.Game.TerminalUI/Views/MapView.cs`

### Monster AI Improvements

- `dotnet/framework/LablabBean.Game.Core/Services/GameStateManager.cs`
- Or create: `dotnet/framework/LablabBean.Game.Core/AI/MonsterAI.cs`

### Activity Log System (New Files)

- `dotnet/framework/LablabBean.Game.TerminalUI/Services/ActivityLogService.cs`
- `dotnet/framework/LablabBean.Game.TerminalUI/Views/ActivityLogView.cs`
- `dotnet/framework/LablabBean.Game.Core/Logging/ActivityLogger.cs`
- `dotnet/framework/LablabBean.Game.Core/Logging/ActivityLoggerProvider.cs`

## Testing

### Test Cases

- **TC-001**: Messages panel removed
  - Expected: No duplicate message display
  - Status: ✅ Pass (implemented)

- **TC-002**: No rendering artifacts
  - Expected: Clean rendering near HUD
  - Status: ✅ Pass (bounds checking added)

- **TC-003**: Monster aggro range
  - Expected: Only nearby monsters move
  - Status: ✅ Pass (15-tile range implemented)

- **TC-004**: Activity log displays
  - Expected: Combat messages shown in Activity Log tab
  - Status: ⏳ Pending (Phase 3)

- **TC-005**: Activity log colors
  - Expected: Damage=red, info=white, success=green
  - Status: ⏳ Pending (Phase 3)

### Acceptance Criteria

- [x] Messages panel removed from HUD
- [x] No weird characters on right side (bounds checking improved)
- [x] Monsters only activate within aggro range
- [ ] Activity Log tab exists and displays messages
- [ ] Activity log color-coded properly
- [ ] Custom logger integrated with ILogger
- [ ] Performance not degraded

## Mock-up: HUD Layout

```
┌─────────────────────────────────────────────┐
│ Player Stats            │ Tabs:            │
│ Health: 100/100         │ ┌──────┬────────┐│
│ Attack: 10              │ │Debug │Activity││
│ Defense: 5              │ └──────┴────────┘│
│                         │                  │
│ Dungeon: Level 1        │ [Active Tab]     │
│ Location: (10, 5)       │ • Monster g      │
│                         │   takes 5 damage │
│                         │ • You move north │
│                         │ • Monster o      │
│                         │   attacks you    │
└─────────────────────────────────────────────┘
```

## Activity Log Message Format

```csharp
// Example messages
activityLog.Add("You attack Goblin for 10 damage", ColorScheme.Attack);
activityLog.Add("Goblin dies!", ColorScheme.Success);
activityLog.Add("You take 5 damage from Orc", ColorScheme.Damage);
activityLog.Add("You picked up Gold Coin (25g)", ColorScheme.Loot);
activityLog.Add("You move to (10, 5)", ColorScheme.Info);
```

## Color Scheme

```csharp
public static class ActivityColors
{
    public static Attribute Attack => new(Color.Yellow, Color.Black);
    public static Attribute Damage => new(Color.Red, Color.Black);
    public static Attribute Success => new(Color.Green, Color.Black);
    public static Attribute Loot => new(Color.Cyan, Color.Black);
    public static Attribute Info => new(Color.White, Color.Black);
    public static Attribute Warning => new(Color.BrightYellow, Color.Black);
}
```

## Integration with Existing Code

### Logging Game Events

```csharp
// In combat code
_logger.LogInformation("[ACTIVITY] You attack {Monster} for {Damage} damage",
    monster.Name, damage);

// In movement code
_logger.LogInformation("[ACTIVITY] You move to ({X}, {Y})",
    player.X, player.Y);

// Custom logger filters by [ACTIVITY] prefix
```

## Performance Considerations

- Activity log limited to 100 messages (configurable)
- Old messages auto-trimmed
- Message queue uses ring buffer for efficiency
- Rendering only visible messages (no full list iteration)

## Known Limitations

- Terminal.Gui v2 color support varies by terminal
- Some terminals may not display colors correctly
- Activity log may need scrollbar for many messages

## Future Enhancements

1. **Message Filtering**: Filter by type (combat, movement, loot)
2. **Search**: Search activity log history
3. **Export**: Save activity log to file
4. **Replay**: Replay last N game events
5. **Timestamps**: Optional timestamp per message
6. **Message Grouping**: Group similar messages ("x3" notation)

## References

- **Roguelike Messages**: <http://www.roguebasin.com/index.php?title=Message_log>
- **Terminal.Gui TabView**: <https://gui-cs.github.io/Terminal.Gui/api/Terminal.Gui.TabView.html>
- **ILogger**: <https://docs.microsoft.com/en-us/dotnet/core/extensions/logging>

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 0.0.3 | 2025-10-20 | Initial specification for UI improvements |

---

**Implementation Status**: 🚧 Partial - Phase 1 & 2 complete (3/4 phases)
**Next Steps**: Implement Phase 3 (Activity Log system)
